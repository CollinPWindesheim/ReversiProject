const Game=function(e){const t={spel:null,size:8,turn:null,move:!0,init:!1,color:null,unread:0,forfeit:!1},n=document.getElementById("pas"),o=document.getElementById("bord"),s=document.getElementById("list"),i=document.getElementById("chat"),l=document.getElementById("spel"),a=document.getElementById("lobby"),r=document.getElementById("finish"),c=document.getElementById("layout"),d=document.getElementById("unread"),u=document.getElementById("status"),m=document.getElementById("loading"),p=document.getElementById("chat-box"),f=document.getElementById("chat-send"),h=e=>new Alert({message:e.toString(),type:"danger",dismissible:!0,buttons:{text:"Herladen",type:"light",callback:function(){location.reload()}},animate:!0,parent:"main"}),g=(new signalR.HubConnectionBuilder).withUrl("/ReversiMvcAppHub").build();function b(){fetch("/api/lobby").then(e=>{if(!e.ok)throw new Error("Er is een fout opgetreden. Probeer het later opnieuw.");return e.json()}).then((function(e){y(e),z(t.spel?"spel":"lobby")})).catch(e=>h(e).show())}function y(e){s.innerHTML="";let t=document.createElement("div");t.classList.add("last-child","text-center"),t.innerText="Er zijn geen spellen waaraan je mee kan doen.",s.append(t),e.forEach(e=>{let t=document.createElement("li");t.classList.add("list-group-item",e.participating?"text-muted":"list-group-item-action","flex-column","align-items-start"),t.setAttribute("data-id",e.spel.id);let n=document.createElement("div");n.classList.add("d-flex","w-100","justify-content-between");let o=document.createElement("h5");o.classList.add("mb-1"),o.innerText=e.speler.name;let i=document.createElement("small");i.classList.add("text-muted"),i.innerText=new Date(e.spel.date).toLocaleString("nl-NL"),n.append(o,i);let l=document.createElement("p");l.classList.add("mb-1"),l.innerText=e.spel.description;let a=document.createElement("small");a.classList.add("text-muted","d-flex"),[{icon:"border_all",info:e.spel.size},{icon:"emoji_events",info:Math.round(e.speler.won/e.speler.sum*100)+"%"}].forEach(e=>{let t=document.createElement("div");t.classList.add("d-flex","mr-4","mr-sm-5");let n=document.createElement("i");n.classList.add("material-icons"),n.innerText=e.icon;let o=document.createElement("span");o.classList.add("mb-auto","ml-3","mt-auto"),o.innerText=e.info,t.append(n,o),a.append(t)}),t.append(n,l,a),s.append(t)})}function E(e){fetch("/api/spel").then(e=>{if(!e.ok)throw new Error("Er is een fout opgetreden. Probeer het later opnieuw.");return e.json()}).then(e).catch(e=>h(e).show())}function L(e,n=!1){t.size=e.spel.size,t.spel=e.spel.id,t.unread=0,i.innerHTML="",p.value="",f.disabled=!0,o.style.setProperty("--tile-size","calc(100% / "+t.size+")"),o.innerHTML="",r.classList.add("d-none"),r.classList.remove("show","fade-in");for(let t=0;t<e.spel.size;t++){let t=document.createElement("div");t.classList.add("row");for(let n=0;n<e.spel.size;n++){let e=document.createElement("div");e.classList.add("tile"),t.append(e)}o.append(t)}let s=e.spelers&&2==e.spelers.length;w(s),n&&s&&v(e,e.spel.bord.length>8?"parallel":"serie")}function v(e,o=!1){e.color&&(t.color=e.color),t.turn=e.spel.turn,w(!0);const s=document.getElementById("turn");1==t.turn?(s.classList.add("black"),s.classList.remove("white")):2==t.turn&&(s.classList.add("white"),s.classList.remove("black")),u.innerText=(t.turn==t.color?"Jij bent":"Je tegenstander is")+" aan de beurt";let i=e.spel.bord.filter(e=>1==e.kleur).length,l=e.spel.bord.filter(e=>2==e.kleur).length;for(let e of document.getElementsByClassName("score-black"))e.innerText=i;for(let e of document.getElementsByClassName("score-white"))e.innerText=l;e.spelers.forEach(e=>document.getElementById("name-"+(1==e.color?"black":"white")).innerText=e.name),C();let a=o||e.spel.history.pop()||!0;P(e.spel.bord,a).then((function(){if(C(e.spel.moves),t.forfeit=!1,e.spel.state>1){const n=document.getElementById("finish-result");let o;2==e.spel.state?(n.classList.remove("d-none"),o=i==l?"Gelijk spel":i>l&&1==t.color||i<l&&2==t.color?"Gefeliciteerd!":"Helaas..."):(n.classList.add("d-none"),o=3==e.spel.state&&1==t.color||4==e.spel.state&&2==t.color?"Je hebt opgegeven":"Je tegenstander heeft opgegeven"),document.getElementById("finish-text").innerText=o,r.classList.remove("d-none"),r.classList.add("show","fade-in"),t.forfeit=!0}else e.color!=e.spel.turn||e.spel.moves.length||(n.classList.remove("d-none"),n.classList.add("show","fade-in"));for(let e of document.getElementsByClassName("forfeit"))e.disabled=t.forfeit}))}function w(e=!1){let t=$("#settings-waiting"),n=$("#settings-playing");e?t.slideUp(250,(function(){n.slideDown(250)})):(u.innerText="Aan het wachten...",n.slideUp(250,(function(){t.slideDown(250)})))}function k(){t.spel=null,fetch("/api/lobby",{method:"DELETE"}).then(e=>{if(!e.ok)throw new Error("Er is een fout opgetreden. Probeer het later opnieuw.");return e.json()}).catch(e=>h(e).show())}function x(){t.forfeit||(t.forfeit=!0,fetch("/api/spel",{method:"DELETE"}).then(e=>{if(!e.ok)throw t.forfeit=!1,new Error("Er is een fout opgetreden. Probeer het later opnieuw.")}).catch(e=>h(e).show()))}function T(){fetch("/api/spel",{method:"PUT"}).then(e=>{if(!e.ok)throw new Error("Er is een fout opgetreden. Probeer het later opnieuw.");n.classList.add("d-none"),n.classList.remove("show","fade-in")}).catch(e=>h(e).show())}function I(){let e=p.value.trim();e&&fetch("/api/message/"+t.spel,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(e=>{if(!e.ok)throw new Error("Kan je bericht niet versturen...");p.value=""}).catch(e=>h(e).show())}function B(){d.classList.toggle("d-none",t.unread<=0),d.innerText=t.unread}function S(e){"lobby"==e?b():E((function(e){L(e,!0),z(t.spel?"spel":"lobby")}))}g.start().catch((function(e){h(e.toString()).show()})),g.on("Init",(function(e){if(t.init)S(e);else{let o="spel";"lobby"==e&&(o="lobby"),fetch("/api/"+o).then(e=>{if(!e.ok)throw new Error("Er is een fout opgetreden. Probeer het later opnieuw.");return e.json()}).then((function(e){!function(e,o){t.init=!0;const s=function(){c.removeEventListener("animationend",s),c.classList.remove("fade","fade-in","show"),m.classList.add("d-none"),"spel"==e&&(o.spelers&&2==o.spelers.length?setTimeout(e=>{v(o,o.spel.bord.length>8?"parallel":"serie")},250):w(!1))};if(document.getElementById("modal-add-submit").addEventListener("click",(function(){let e=document.getElementById("modal-add-description"),n=document.getElementById("modal-add-size");e.matches(":invalid")||n.matches(":invalid")||function(e,n){fetch("/api/lobby",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({Description:e,Size:n})}).then(e=>{if(!e.ok)throw t.spel=null,new Error("Er is een fout opgetreden. Probeer het later opnieuw.");return e.json()}).then(e=>{L(e),z("spel"),$("#modal-add").modal("hide")}).catch(e=>h(e).show())}(e.value.trim(),parseInt(n.value))})),document.getElementById("settings-toggle").addEventListener("click",(function(){let e=document.getElementById("settings"),n=$("#settings-expand");e.classList.contains("expanded")&&!window.matchMedia("(min-width: 768px)").matches?(e.classList.remove("expanded"),n.slideUp(250)):(e.classList.add("expanded"),t.unread=0,n.slideDown(250,B))})),document.getElementById("leave").addEventListener("click",k),document.getElementById("forfeit").addEventListener("click",x),n.querySelector("button").addEventListener("click",T),r.querySelector("button").addEventListener("click",(function(){t.color=null,t.turn=null,t.spel=null,t.size=8,g.invoke("Group").catch(e=>h(e.toString()))})),p.addEventListener("keypress",(function(e){if("Enter"==e.key&&!e.shiftKey)return e.preventDefault(),I(),!1})),p.addEventListener("input",(function(){f.disabled=!p.value.trim()})),f.addEventListener("click",I),$("#list").on("click","li.list-group-item-action",(function(){var e;e=$(this).data("id"),t.spel=e,fetch("/api/lobby/"+e,{method:"PUT",headers:{Accept:"application/json"}}).then(e=>{if(!e.ok)throw t.spel=null,new Error("Er is een fout opgetreden. Probeer het later opnieuw.")}).catch(e=>h(e).show())})),$("#bord").on("click",".tile.move",(function(){let e=$(this);var n,o;n=e.index(),o=e.parent().index(),t.color==t.turn&&t.move&&(t.move=!1,fetch("/api/spel",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({X:n,Y:o})}).then(e=>{if(t.move=!0,!e.ok)throw new Error("Deze zet is ongeldig.")}).catch(e=>h(e).show()))})),"lobby"==e){let t=o.find(e=>e.participating);t?(o=t,e="spel"):y(o)}"spel"==e&&L(o);z(e),c.classList.add("fade-in","show"),c.addEventListener("animationend",s)}(o,e)})).catch(e=>h(e).show())}})),g.on("Group",S),g.on("Update",b),g.on("Start",(function(e){t.spel==e?g.invoke("Group").catch(e=>h(e.toString())):b()})),g.on("Move",(function(){E(v)})),g.on("Finish",(function(e){v(e)})),g.on("Message",(function(e){e.spelId==t.spel&&function(e){if(!e.type){let n=document.createElement("div");n.classList.add("chat-bubble-msg"),n.innerText=e.content;let o=i.lastElementChild;if(o&&(e.color==t.color&&o.classList.contains("chat-bubble-right")||e.color!=t.color&&o.classList.contains("chat-bubble-left")))o.lastElementChild.append(n);else{let o=document.createElement("div");o.classList.add("chat-bubble","chat-bubble-"+(e.color==t.color?"right":"left"));let s=document.createElement("div");s.classList.add("chat-bubble-body"),s.append(n),o.append(s),i.append(o)}t.color!=e.color&&null===i.offsetParent&&(t.unread++,B())}i.scrollTo(0,i.scrollHeight)}(e)}));const j=(e,n)=>!(e<0||e>=t.size||n<0||n>=t.size),z=function(e){let t="lobby"!=e&&e;l.classList.toggle("d-none",!t),a.classList.toggle("d-none",t)},A=(e,t,n)=>{if(void 0===t&&void 0===n&&"object"==typeof e&&(t=e.x,n=e.y,e=e.color||e.kleur),!j(t,n))return console.error("Given coordinates are not valid."),new Promise((e,t)=>t("Given coordinates are not valid."));1==e||"zwart"==(e+"").toLowerCase()?e="black":2!=e&&"wit"!=(e+"").toLowerCase()||(e="white");const s=o.querySelector(".row:nth-child("+(n+1)+")>.tile:nth-child("+(t+1)+")");let i=s.querySelector(".fiche"),l=!1;i?(i.classList.contains(e.toLowerCase())&&(l=!0),i.classList.remove("black","white")):(i=document.createElement("div"),s.append(i)),i.classList.add("fiche"),"black"!=e&&"white"!=e||i.classList.add(e.toLowerCase());const a=function(e){i.removeEventListener("transitionend",a),i.removeEventListener("animationend",a),e(i)};return new Promise(e=>{l?setTimeout(t=>e(),250):(i.addEventListener("transitionend",(function(){a(e)})),i.addEventListener("animationend",(function(){a(e)})))})},P=(e,n=!1,o=!1)=>{if(o)for(var s=0;s<t.size;s++)for(var i=0;i<t.size;i++){e.find(e=>e.x==s&&e.y==i)||A("",s,i)}const l=t=>{if(e.length)if("object"==typeof n&&Number.isInteger(n.x)&&Number.isInteger(n.y)){n.layer||(e=e.filter(e=>j(e.x,e.y)),n.layer=0);let i=[];for(var o=n.x-n.layer;o<=n.x+n.layer;o++)for(var s=n.y-n.layer;s<=n.y+n.layer;s++)o!=n.x-n.layer&&o!=n.x+n.layer&&s!=n.y-n.layer&&s!=n.y+n.layer||!j(o,s)||(e=e.filter(e=>e.x!=o||e.y!=s||(i.push(e),!1)));if(n.layer++,i.length){let e=!0;i.forEach(n=>A(n).then(n=>{e&&(e=!1,l(t))}))}else setTimeout(e=>l(t),250)}else!0===n||"serie"==n?A(e.shift()).then(e=>l(t)):!1!==n&&"parallel"!=n||e.forEach(e=>A(e).then(e=>t()));else t()};return new Promise(e=>{l(e)})},C=e=>{for(let e of document.getElementsByClassName("tile")||[])e.classList.remove("move");e&&(Array.isArray(e)||(e=[e]),e.forEach(e=>document.querySelector(".row:nth-child("+(e.y+1)+")>.tile:nth-child("+(e.x+1)+")").classList.add("move")))}}(),Alert=function(e){const t=["primary","secondary","success","danger","warning","info","light","dark"];let n,o,s,i=!1,l=[];const a=document.createElement("div"),r=document.createElement("div"),c=document.createElement("p"),d=document.createElement("i");d.classList.add("col-auto","material-icons","d-none","d-sm-inline-block"),r.classList.add("row"),c.classList.add("col"),a.classList.add("alert"),r.append(c),a.append(r);const u=document.createElement("div");u.classList.add("btns","text-right"),a.append(u);const m=document.createElement("button"),p=document.createElement("span");function f(e){if(void 0===e)return n;n=e,c.innerText=n}function h(e){if(void 0===e)return o;let n=!0;t.forEach(t=>{let s=e==t;a.classList.toggle("alert-"+t,s),s&&(o=t,n=!1)}),n&&(o="")}function g(e){if(void 0===e)return s;s=e instanceof HTMLElement?e:"string"==typeof e?document.querySelector(e):document.body}function b(e=null){null===e&&(e=!0),0!=(e=!!e)&&(a.classList.toggle("alert-dismissible",e),e?a.append(m):m.remove())}function y(e){l.forEach(e=>{e.remove()}),l=[],e&&(Array.isArray(e)||(e=[e]),e.forEach(e=>{if("object"==typeof e){let n=document.createElement("button");n.setAttribute("type","button"),n.classList.add("btn"),n.innerText=e.text,"function"==typeof e.callback&&n.addEventListener("click",e.callback),e.close&&n.addEventListener("click",w),t.indexOf(e.type)>=0&&n.classList.add("btn-"+e.type),u.append(n),l.push(n)}}))}function E(e){e?(d.innerText=e,r.prepend(d)):d.remove()}function L(e){i=!!e}function v(){document.contains(a)&&!a.classList.contains("fade-out")&&a.classList.add("shake")}function w(){a.classList.remove("fade-in"),document.contains(a)&&(i?a.classList.add("fade-out"):a.remove())}return p.innerHTML="&times;",m.append(p),m.classList.add("close"),m.setAttribute("type","button"),m.setAttribute("aria-label","Close"),m.addEventListener("click",w),a.addEventListener("animationend",(function(){a.classList.contains("fade-out")&&(a.classList.remove("fade-out"),i&&a.remove()),a.classList.remove("fade-in","shake")})),"object"!=typeof e&&(e={}),h(e.type||"danger"),g(e.parent||document.body),f(e.message||""),b(e.dismissible||!1),y(e.buttons||[]),E(e.icon||""),L(e.animate),e.shake&&setTimeout(v,Number.isInteger(e.shake)&&e.shake>0?e.shake:3e3),{show:function(e=0){a.classList.toggle("fade-in",i),s.prepend(a);let t=JSON.parse(localStorage.getItem("Alert"));t&&t.length||(t=[]),t.push({message:n,type:o}),localStorage.setItem("Alert",JSON.stringify(t)),e>0&&setTimeout(w,e)},hide:w,type:h,parent:g,message:f,dismissible:b,buttons:y,icon:E,animate:L,shake:v,history:function(){let e=JSON.parse(localStorage.getItem("Alert"));e&&e.length&&console.log(e.map(e=>"<type "+e.type+"> - <"+e.message+">").join("\n"))},reset:function(){localStorage.setItem("Alert","[]")}}};